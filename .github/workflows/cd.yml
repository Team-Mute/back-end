name: cd

on:
  workflow_run:
    workflows: [ "ci" ]
    types: [ completed ]
  workflow_dispatch: { }

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Install and configure the Koyeb CLI
        uses: koyeb-community/koyeb-actions@v2
        with:
          api_token: ${{ secrets.KOYEB_API_TOKEN }}

      - name: Update existing Koyeb service
        env:
          KOYEB_TOKEN: ${{ secrets.KOYEB_API_TOKEN }}
        run: |
          koyeb service update my-spring-app/mute-api \
            --git https://github.com/Team-Mute/back-end \
            --git-branch main \
            --git-builder buildpack \
            --type web \
            --instance-type micro \
            --regions tyo \
            --region '!fra' \
            --env SPRING_PROFILES_ACTIVE=ci \
            --env BP_JVM_VERSION=17 \
            --env SPRING_DATASOURCE_URL=${{ secrets.NEON_JDBC_URL }} \
            --env SPRING_DATASOURCE_USERNAME=${{ secrets.NEON_DB_USER }} \
            --env SPRING_DATASOURCE_PASSWORD=${{ secrets.NEON_DB_PASS }} \
            --env AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
            --env AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
            --env AWS_REGION=${{ secrets.AWS_REGION }} \
            --env AWS_STACK_AUTO=${{ secrets.AWS_STACK_AUTO }} \
            --env AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }} \
            --env JAVA_TOOL_OPTIONS='-XX:MaxRAMPercentage=75.0 -Xms128m -Xmx256m' \
            --ports 8080:http \
            --routes /:8080 \
            --checks "8080:http:/actuator/health?grace=30s&interval=10s"
