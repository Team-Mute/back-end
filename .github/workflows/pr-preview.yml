name: pr-preview
on:
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install & Configure Koyeb CLI
        uses: koyeb-community/koyeb-actions@v2
        with:
          api_token: ${{ secrets.KOYEB_API_TOKEN }}

      - name: Deploy PR preview to Koyeb (buildpack)
        uses: koyeb/action-git-deploy@v1
        with:
          # 브랜치/PR마다 고유하게: 기본값이 <repo>-<branch>, <branch>라서 그대로 둬도 됨
          app-name: my-spring-app-pr
          service-name: pr-${{ github.event.pull_request.number }}
          git-builder: buildpack
          build-env: "BP_JAVA_VERSION=17.*"
          service-ports: "8080:http"
          service-routes: "/:8080"
          # 필요 ENV (네가 쓰는 것들로 채워넣기)
          service-env: >-
            SPRING_DATASOURCE_URL=${{ secrets.NEON_JDBC_URL }},
                        SPRING_DATASOURCE_USERNAME=${{ secrets.NEON_DB_USER }},
                        SPRING_DATASOURCE_PASSWORD=${{ secrets.NEON_DB_PASS }},
                        AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }},
                        AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }},
                        AWS_REGION=${{ secrets.AWS_REGION }},
                        AWS_STACK_AUTO=${{ secrets.AWS_STACK_AUTO }},
                        AWS_S3_BUCKET=${{ secrets.AWS_S3_BUCKET }},
                        PORT=8080
